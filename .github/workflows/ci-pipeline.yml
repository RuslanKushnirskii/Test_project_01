name: CI/CD Pipeline with Artifacts and Deployment

# 1. –£–°–õ–û–í–ò–Ø –ó–ê–ü–£–°–ö–ê (–∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ —Ç—Ä–∏–≥–≥–µ—Ä–∞–º –≤ Azure DevOps)
on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

# 2. –û–ü–†–ï–î–ï–õ–ï–ù–ò–ï –ü–ï–†–ï–ú–ï–ù–ù–´–• –î–õ–Ø –í–°–ï–ì–û –ü–ê–ô–ü–õ–ê–ô–ù–ê (–∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ Variables)
env:
  ARTIFACT_NAME: 'drop'           # –ò–º—è –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞, –∫–∞–∫ –≤ –º–µ—Ç–æ–¥–∏—á–∫–µ
  DOTNET_VERSION: '6.0.x'         # –í–µ—Ä—Å–∏—è .NET –¥–ª—è —Å–±–æ—Ä–∫–∏ (–º–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ –≤–∞—à —Å—Ç–µ–∫)

# 3. –ú–ù–û–ì–û–≠–¢–ê–ü–ù–´–ô –ö–û–ù–í–ï–ô–ï–† (STAGES) - –∫–ª—é—á–µ–≤–æ–µ –Ω–æ–≤–æ–≤–≤–µ–¥–µ–Ω–∏–µ
jobs:
  build:
    name: Build and Test Stage
    runs-on: ubuntu-latest
    # 3.1 –≠–¢–ê–ü "BUILD" (–°–ë–û–†–ö–ê)
    outputs: # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –≤—ã—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —ç—Ç–∞–ø–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤–µ—Ä—Å–∏—é —Å–±–æ—Ä–∫–∏)
      build-version: ${{ steps.set-version.outputs.version }}
    steps:
      - name: Checkout repository code
        uses: actions/checkout@v4

      - name: Setup .NET Core
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Install dependencies
        run: |
          echo "üì¶ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –ø—Ä–æ–µ–∫—Ç–∞..."
          dotnet restore PartsUnlimited.sln  # –≠–º—É–ª–∏—Ä—É–µ–º —Ä–∞–±–æ—Ç—É —Å —Ä–µ—à–µ–Ω–∏–µ–º –∏–∑ –º–µ—Ç–æ–¥–∏—á–∫–∏
          echo "‚úÖ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã."

      - name: Build the solution
        run: |
          echo "üèóÔ∏è  –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Å–±–æ—Ä–∫–∞ —Ä–µ—à–µ–Ω–∏—è..."
          dotnet build PartsUnlimited.sln --configuration Release --no-restore
          echo "‚úÖ –°–±–æ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞."

      - name: Run unit tests
        run: |
          echo "üß™ –ó–∞–ø—É—Å–∫ –º–æ–¥—É–ª—å–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤..."
          dotnet test PartsUnlimited.sln --configuration Release --no-build --verbosity normal
          echo "‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ."

      # 3.2 –®–ê–ì –î–õ–Ø –ì–ï–ù–ï–†–ê–¶–ò–ò –í–ï–†–°–ò–ò (–∏–º–∏—Ç–∞—Ü–∏—è)
      - name: Generate build version
        id: set-version
        run: |
          echo "–í–µ—Ä—Å–∏—è —Å–±–æ—Ä–∫–∏: 1.0.${{ github.run_number }}"
          echo "version=1.0.${{ github.run_number }}" >> $GITHUB_OUTPUT

      # 3.3 –ü–£–ë–õ–ò–ö–ê–¶–ò–Ø –ê–†–¢–ï–§–ê–ö–¢–û–í –°–ë–û–†–ö–ò (–ö–õ–Æ–ß–ï–í–û–ô –®–ê–ì)
      - name: Publish build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: |
            **/bin/Release/**/*.dll
            **/publish/
          retention-days: 7
        if: success()

  deploy:
    name: Deploy to Azure Stage (Simulated)
    runs-on: ubuntu-latest
    needs: build # –≠—Ç–æ—Ç —ç—Ç–∞–ø –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —É—Å–ø–µ—à–Ω–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —ç—Ç–∞–ø–∞ 'build'
    # 3.4 –≠–¢–ê–ü "DEPLOY" (–†–ê–ó–í–ï–†–¢–´–í–ê–ù–ò–ï - –≤ –Ω–∞—à–µ–º —Å–ª—É—á–∞–µ —ç–º—É–ª—è—Ü–∏—è)
    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}

      - name: Display artifact structure
        run: |
          echo "üìÇ –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞:"
          find . -type f -name "*.dll" | head -5

      - name: Simulate Azure App Service deployment
        run: |
          echo "üöÄ –ù–∞—á–∏–Ω–∞–µ–º —ç–º—É–ª—è—Ü–∏—é —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è –≤ Azure App Service..."
          echo "–ò–º—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è: pul-yaml-mirea-${{ github.actor }}"
          echo "–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∞—Ä—Ç–µ—Ñ–∞–∫—Ç: ${{ env.ARTIFACT_NAME }}"
          echo "–í–µ—Ä—Å–∏—è —Å–±–æ—Ä–∫–∏: ${{ needs.build.outputs.build-version }}"
          # –≠–º—É–ª—è—Ü–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Å—Ç—Ä–æ–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∏–∑ Secrets
          if [ -n "${{ secrets.DEFAULT_CONNECTION_STRING }}" ]; then
            echo "‚úÖ –°—Ç—Ä–æ–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î –Ω–∞–π–¥–µ–Ω–∞ –≤ Secrets (–Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –≤ –ª–æ–≥–∞—Ö)."
          else
            echo "‚ö†Ô∏è  –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è DEFAULT_CONNECTION_STRING –Ω–µ –∑–∞–¥–∞–Ω–∞. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–∞—è –ë–î."
          fi
          echo "‚úÖ –≠–º—É–ª—è—Ü–∏—è —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ '—Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–æ'."
